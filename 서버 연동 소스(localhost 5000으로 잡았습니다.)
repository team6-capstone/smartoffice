
const express = require('express'); 
const bodyParser=require('body-parser');
const app=express();
const router = express();
const port=process.env.PORT || 5000;
const session=require('express-session');
const cookieparser = require("cookie-parser");
const cors=require('cors');
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({extended:true}));

var user="";
var user1="";
const mysql=require('mysql');
const { query } = require('express');


const connection=mysql.createConnection({
   host: "sjuteam6.cafe24.com",
   user: "sjuteam6",
   password:"sejongteam6",
   port : "3306",
   database : "sjuteam6"
});
connection.connect();


app.use(cors({
  origin:["http://localhost:3000"],
  methods : ["GET", "POST"],
  credentials : true
}));

app.use(cookieparser());

app.use(
  session({
    key : "userid",
    secret : "keyboardcat",
    resave : false,
    saveUninitialized : false,
    cookie :{
         expires : 60*60*24,
    },
  })
); //로그인 세션

app.get('/hello', (req, res)=> {
  connection.query(
    "SELECT * FROM user",
    (err, rows, fields) => {
       res.send(rows);
    }
  );
});  //관리자 - deleteperson 사원조회기능

app.get('/api', (req, res)=>{
  connection.query(
    "SELECT * FROM seat",
    (err, rows, fields) =>{
      res.send(rows);
    }
);
}); //관리자 층별현황 조회기능


app.post('/hello', (req, res)=>{
 
  let name=req.body.name;
  let id=req.body.id;
  let pw=req.body.pw;
  let email=req.body.email;
  let department=req.body.department;
  let rank=req.body.rank;
  let phone=req.body.phone;
  let state=req.body.state;
  let params = [id, department, rank, name, phone, email, state, pw];
  connection.query(
    "INSERT INTO user VALUES (?, ?, ?, ?, ?, ?, ?, ?)", 
    params,
    (err, rows, fields) =>{
      res.send(rows);
      console.log(err);
    });
}); //관리자 사원등록기능

app.delete('/hello/:id', (req, res) => {
  
  let params=[req.params.id];
  connection.query("DELETE FROM user WHERE id = (?)", params,
     (err, rows, fields) => {
       res.send(rows);
       console.log(err);
     }
  )
    });//관리자 deleteperson 사원삭제기능

app.get('/hello2', (req, res)=>{
  if(req.session.user){
    res.send({LoggedIn : true, user : req.session.user})
    console.log(req.session.user);
  }else{
    res.send({LoggedIn:false})
  }
} //userlogin 세션처리

);

app.post('/hello2', (req, res)=>{
  const user_id=req.body.SenduserID;
  const user_pw=req.body.SenduserPW;
  let params=[user_id, user_pw];
  connection.query("SELECT * FROM user WHERE id=(?) AND pw=(?)", 
  params,
  (err, rows, result) =>{
    
    if(err){
      res.send({ err:err});
    }
    if(rows.length>0){
      req.session.user=result;
      res.send(result);
    }else{
      
      res.send({message:"로그인 실패"});
    }
  }
  );
});//userlogin


app.post('/hello3', (req, res)=>{
   user=req.body.SendID;
   res.send(user);
   
});//userlogin-Reservation간 아이디 넘기기 id저장

app.get('/hello3', (req, res)=>{
   connection.query("SELECT * FROM user WHERE id=(?)",
   user, (err, rows, result)=>{
     res.send(rows);
     console.log(user);
   });
});//userlogin-Reservation간 아이디 넘기기 id꺼내기


app.post('/hello4', (req, res)=>{
  let user=req.body.uid;
  let seatid=req.body.seat_id;
  let date=req.body.date;
  let starttime=req.body.start_time;
  let endtime=req.body.end_time;
  let params=[seatid, user, date, starttime, endtime];
  connection.query(
    "INSERT INTO seat_log VALUES (null, ?, ?, ?, ?, ?, 1)", params,
    (err, rows, fields) =>{
      res.send(rows);
      console.log(err);
    }
)
})//좌석예약



app.get('/hello4', (req, res)=>{
  connection.query("SELECT * FROM seat_log WHERE user = (?)", user, (err, rows, fields)=>{
    res.send(rows);
  });
});//예약정보삭제-조회기능

app.delete('/hello4/:id', (req, res) => {
  
  let params=[req.params.id];
  connection.query("DELETE FROM seat_log WHERE id = (?)", params,
     (err, rows, fields) => {
       res.send(rows);
       console.log(err);
     }
  )
    });//얘약정보삭제

    app.get('/hello5', (req, res)=>{
      if(req.session.user){
        res.send({LoggedIn : true, user : req.session.user})
        console.log(req.session.user);
      }else{
        res.send({LoggedIn:false})
      }
    }
    
    );//관리자로그인 세션처리

    app.post('/hello5', (req, res)=>{
      const manager_id=req.body.SendManagerID;
      const manager_pw=req.body.SendManagerPW;
      let params=[manager_id, manager_pw];
      connection.query("SELECT * FROM manager WHERE id=(?) AND pw=(?)", 
      params,
      (err, rows, result) =>{
        
        if(err){
          res.send({ err:err});
        }
        if(rows.length>0){
          req.session.user=result;
          res.send(result);
        }else{
          
          res.send({message:"로그인 실패"});
        }
      }
      );
    });//관리자로그인
  
    app.post('/hello6', (req, res)=>{
     user1=req.body.uname;
      res.send(user1);
    });//사원찾기 아이디입력

    app.get('/hello6', (req, res)=>{
      connection.query(
        "SELECT * FROM seat_log WHERE user=(?)", user1,
        (err, rows, fields) =>{
          res.send(rows);//사원찾기 사원정보꺼내오기
        }
    );
    });

app.listen(port, () => console.log(`Listen on port ${port}`));

const express = require('express');
const bodyParser=require('body-parser');
const app=express();
const router = express();
const port=process.env.PORT || 5000;
const session=require('express-session');
const cookieparser = require("cookie-parser");
const cors=require('cors');
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({extended:true}));


const mysql=require('mysql');


const connection=mysql.createConnection({
   host: "sjuteam6.cafe24.com",
   user: "sjuteam6",
   password:"sejongteam6",
   port : "3306",
   database : "sjuteam6"
});
connection.connect();


app.use(cors({
  origin:["http://localhost:3000"],
  methods : ["GET", "POST"],
  credentials : true
}));

app.use(cookieparser());

app.use(
  session({
    key : "userid",
    secret : "keyboardcat",
    resave : false,
    saveUninitialized : false,
    cookie :{
         expires : 60*60*24,
    },
  })
);

app.get('/hello', (req, res)=> {
  connection.query(
    "SELECT * FROM user",
    (err, rows, fields) => {
       res.send(rows);
    }
  );
});

app.get('/api', (req, res)=>{
  connection.query(
    "SELECT * FROM seat",
    (err, rows, fields) =>{
      res.send(rows);
    }
);
});


app.post('/hello', (req, res)=>{
 
  let name=req.body.name;
  let id=req.body.id;
  let pw=req.body.pw;
  let email=req.body.email;
  let department=req.body.department;
  let rank=req.body.rank;
  let phone=req.body.phone;
  let state=req.body.state;
  let params = [id, department, rank, name, phone, email, state, pw];
  connection.query(
    "INSERT INTO user VALUES (?, ?, ?, ?, ?, ?, ?, ?)", 
    params,
    (err, rows, fields) =>{
      res.send(rows);
      console.log(err);
    });
});

app.delete('/hello/:id', (req, res) => {
  
  let params=[req.params.id];
  connection.query("DELETE FROM user WHERE id = (?)", params,
     (err, rows, fields) => {
       res.send(rows);
       console.log(err);
     }
  )
    });

app.get('/hello2', (req, res)=>{
  if(req.session.user){
    res.send({LoggedIn : true, user : req.session.user})
    console.log(req.session.user);
  }else{
    res.send({LoggedIn:false})
  }
}

);

app.post('/hello2', (req, res)=>{
  const user_id=req.body.SenduserID;
  const user_pw=req.body.SenduserPW;
  let params=[user_id, user_pw];
  connection.query("SELECT * FROM user WHERE id=(?) AND pw=(?)", 
  params,
  (err, result) =>{
    
    if(err){
      res.send({ err:err});
    }
    if(result.length>0){
      req.session.user=result;
      res.send(result);
    }else{
      
      res.send({message:"로그인 실패"});
    }
  }
  );
});
  
app.listen(port, () => console.log(`Listen on port ${port}`));
